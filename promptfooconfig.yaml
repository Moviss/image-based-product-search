description: "Image analysis prompt evaluation — furniture classification accuracy"

providers:
  - id: file://promptfoo/providers/image-analysis.ts
    label: "Claude Sonnet (image analysis)"
    config:
      model: claude-sonnet-4-5-20250929
      max_tokens: 1024

prompts:
  - id: file://prompts/image-analysis.txt
    label: "v1: baseline"

# Test cases loaded from external file
tests: file://promptfoo/test-cases.yaml

# Default assertions applied to every test case
defaultTest:
  vars:
    # Pre-fetched taxonomy injected into {{taxonomy}} placeholder in prompts
    taxonomy: file://promptfoo/fixtures/taxonomy.txt
  assert:
    # 1. Output must be valid JSON
    - type: is-json
      weight: 1
      metric: json-valid

    # 2. JSON must match expected schema
    - type: javascript
      weight: 1
      metric: schema-valid
      value: |
        const parsed = JSON.parse(output);
        if (typeof parsed.isFurniture !== 'boolean') return { pass: false, reason: 'missing isFurniture field' };
        if (parsed.isFurniture) {
          if (!parsed.category || !parsed.type) return { pass: false, reason: 'furniture=true but missing category/type' };
        }
        return { pass: true, score: 1 };

    # 3. Furniture detection — does isFurniture match expected?
    - type: javascript
      weight: 2
      metric: furniture-detection
      value: |
        const parsed = JSON.parse(output);
        const expected = context.vars.expectedIsFurniture;
        const pass = parsed.isFurniture === expected;
        return {
          pass,
          score: pass ? 1 : 0,
          reason: pass
            ? `Correctly classified as ${expected ? 'furniture' : 'non-furniture'}`
            : `Expected isFurniture=${expected}, got ${parsed.isFurniture}`
        };

    # 4. Category accuracy — does category match expected? (only for furniture images)
    - type: javascript
      weight: 2
      metric: category-accuracy
      value: |
        const parsed = JSON.parse(output);
        if (context.vars.expectedIsFurniture === false) {
          return { pass: true, score: 1, reason: 'Non-furniture — category check skipped' };
        }
        const pass = parsed.category === context.vars.expectedCategory;
        return {
          pass,
          score: pass ? 1 : 0,
          reason: pass
            ? `Category correct: "${parsed.category}"`
            : `Expected "${context.vars.expectedCategory}", got "${parsed.category}"`
        };

    # 5. Type accuracy — does type match expected? (only for furniture images)
    - type: javascript
      weight: 2
      metric: type-accuracy
      value: |
        const parsed = JSON.parse(output);
        if (context.vars.expectedIsFurniture === false) {
          return { pass: true, score: 1, reason: 'Non-furniture — type check skipped' };
        }
        const pass = parsed.type === context.vars.expectedType;
        return {
          pass,
          score: pass ? 1 : 0,
          reason: pass
            ? `Type correct: "${parsed.type}"`
            : `Expected "${context.vars.expectedType}", got "${parsed.type}"`
        };

    # 6. Latency bound — single API call should complete within 15 seconds
    - type: latency
      threshold: 15000
      weight: 0

    # 7. Cost bound — single image analysis call should cost under $0.05
    - type: cost
      threshold: 0.05
      weight: 0

# Execution settings
evaluateOptions:
  maxConcurrency: 2
  cache: true
  delay: 1000

outputPath: ./promptfoo-output.json
